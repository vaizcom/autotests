{"uid":"45e22a2aa56d082b","name":"Проверка удаления задачи: разрешено владельцу и менеджеру, запрещено мемберу и гостю","fullName":"tests.test_backend.task_service.del_task.test_delete_task#test_delete_task_access_control","historyId":"a30e4c51d67746960cc3abb23a8a300e","time":{"start":1763996345204,"stop":1763996346247,"duration":1043},"description":"\n    Быстрая проверка прав на удаление задачи:\n      - owner, manager -> 200\n      - member, guest  -> 403\n    ","descriptionHtml":"<pre><code>Быстрая проверка прав на удаление задачи:\n  - owner, manager -&gt; 200\n  - member, guest  -&gt; 403\n</code></pre>\n","status":"failed","statusMessage":"AssertionError: Финальное удаление владельцем не удалось: {\"payload\":null,\"type\":\"DeleteTask\",\"error\":{\"code\":\"NotFound\",\"originalType\":\"DeleteTask\",\"meta\":{\"model\":\"Task\"}}}\nassert 400 == 200\n +  where 400 = <Response [400]>.status_code","statusTrace":"request = <FixtureRequest for <Function test_delete_task_access_control[member]>>\nmain_space = '6866309d85fb8d104544a61e', main_board = '6866731185fb8d104544e826'\nclient_fixture = 'member_client', expected_status = 403\nowner_client = <tests.core.client.APIClient object at 0x7f9752c6cdd0>\n\n    @pytest.mark.parametrize(\n        'client_fixture, expected_status',\n        [\n            ('owner_client', 200),\n            ('manager_client', 200),\n            ('member_client', 403),\n            ('guest_client', 403),\n        ],\n        ids=['owner', 'manager', 'member', 'guest'],\n    )\n    @allure.parent_suite(\"access_task\")\n    @allure.title(\"Проверка удаления задачи: разрешено владельцу и менеджеру, запрещено мемберу и гостю\")\n    def test_delete_task_access_control(request, main_space, main_board, client_fixture, expected_status, owner_client):\n        \"\"\"\n        Быстрая проверка прав на удаление задачи:\n          - owner, manager -> 200\n          - member, guest  -> 403\n        \"\"\"\n        # Создаём задачу владельцем\n        payload = create_task_endpoint(space_id=main_space, board=main_board)\n        create_resp = create_task(owner_client, payload)\n        assert create_resp.status_code == 200, f\"Не удалось создать задачу предварительно: {create_resp.text}\"\n        task_id = create_resp.json()[\"payload\"][\"task\"][\"_id\"]\n    \n        try:\n            client = get_client(request, client_fixture)\n            with allure.step(f\"Пытаемся удалить задачу под ролью: {client_fixture}, {expected_status}\"):\n                del_resp = client.post(**delete_task_endpoint(space_id=main_space, task_id=task_id))\n>               assert del_resp.status_code == expected_status, (\n                    f\"Ожидали {expected_status}, получили {del_resp.status_code}: {del_resp.text}\"\n                )\nE               AssertionError: Ожидали 403, получили 200: {\"payload\":{\"task\":{\"_id\":\"692472b9ef0dc1803d0d5176\",\"name\":\"Untitled task\",\"group\":\"6866731185fb8d104544e827\",\"board\":\"6866731185fb8d104544e826\",\"project\":\"686672af85fb8d104544e798\",\"parentTask\":null,\"types\":[],\"priority\":1,\"hrid\":\"CCSS-29177\",\"followers\":{\"6866346d85fb8d104544ae41\":\"creator\"},\"archiver\":null,\"completed\":false,\"assignees\":[],\"subtasks\":[],\"milestones\":[],\"dueStart\":null,\"dueEnd\":null,\"rightConnectors\":[],\"leftConnectors\":[],\"archivedAt\":null,\"completedAt\":null,\"customFields\":[],\"deleter\":\"6866310b85fb8d104544ab1d\",\"deletedAt\":\"2025-11-24T14:59:05.889Z\",\"creator\":\"6866346d85fb8d104544ae41\",\"createdAt\":\"2025-11-24T14:59:05.378Z\",\"updatedAt\":\"2025-11-24T14:59:05.911Z\",\"document\":\"692472b9ef0dc1803d0d5177\",\"milestone\":null}},\"type\":\"DeleteTask\"}\nE               assert 200 == 403\nE                +  where 200 = <Response [200]>.status_code\n\ntests/test_backend/task_service/del_task/test_delete_task.py:37: AssertionError\n\nDuring handling of the above exception, another exception occurred:\n\nrequest = <FixtureRequest for <Function test_delete_task_access_control[member]>>\nmain_space = '6866309d85fb8d104544a61e', main_board = '6866731185fb8d104544e826'\nclient_fixture = 'member_client', expected_status = 403\nowner_client = <tests.core.client.APIClient object at 0x7f9752c6cdd0>\n\n    @pytest.mark.parametrize(\n        'client_fixture, expected_status',\n        [\n            ('owner_client', 200),\n            ('manager_client', 200),\n            ('member_client', 403),\n            ('guest_client', 403),\n        ],\n        ids=['owner', 'manager', 'member', 'guest'],\n    )\n    @allure.parent_suite(\"access_task\")\n    @allure.title(\"Проверка удаления задачи: разрешено владельцу и менеджеру, запрещено мемберу и гостю\")\n    def test_delete_task_access_control(request, main_space, main_board, client_fixture, expected_status, owner_client):\n        \"\"\"\n        Быстрая проверка прав на удаление задачи:\n          - owner, manager -> 200\n          - member, guest  -> 403\n        \"\"\"\n        # Создаём задачу владельцем\n        payload = create_task_endpoint(space_id=main_space, board=main_board)\n        create_resp = create_task(owner_client, payload)\n        assert create_resp.status_code == 200, f\"Не удалось создать задачу предварительно: {create_resp.text}\"\n        task_id = create_resp.json()[\"payload\"][\"task\"][\"_id\"]\n    \n        try:\n            client = get_client(request, client_fixture)\n            with allure.step(f\"Пытаемся удалить задачу под ролью: {client_fixture}, {expected_status}\"):\n                del_resp = client.post(**delete_task_endpoint(space_id=main_space, task_id=task_id))\n                assert del_resp.status_code == expected_status, (\n                    f\"Ожидали {expected_status}, получили {del_resp.status_code}: {del_resp.text}\"\n                )\n        finally:\n            # Если не удалили в тесте — удаляем владельцем\n            check_resp = owner_client.post(**delete_task_endpoint(space_id=main_space, task_id=task_id))\n            if expected_status != 200:\n                with allure.step(\"Удаляем владельцем\"):\n                    # Для негативных ролей задача должна существовать и удалиться владельцем\n>                   assert check_resp.status_code == 200, f\"Финальное удаление владельцем не удалось: {check_resp.text}\"\nE                   AssertionError: Финальное удаление владельцем не удалось: {\"payload\":null,\"type\":\"DeleteTask\",\"error\":{\"code\":\"NotFound\",\"originalType\":\"DeleteTask\",\"meta\":{\"model\":\"Task\"}}}\nE                   assert 400 == 200\nE                    +  where 400 = <Response [400]>.status_code\n\ntests/test_backend/task_service/del_task/test_delete_task.py:46: AssertionError","flaky":false,"newFailed":true,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[],"testStage":{"description":"\n    Быстрая проверка прав на удаление задачи:\n      - owner, manager -> 200\n      - member, guest  -> 403\n    ","status":"failed","statusMessage":"AssertionError: Финальное удаление владельцем не удалось: {\"payload\":null,\"type\":\"DeleteTask\",\"error\":{\"code\":\"NotFound\",\"originalType\":\"DeleteTask\",\"meta\":{\"model\":\"Task\"}}}\nassert 400 == 200\n +  where 400 = <Response [400]>.status_code","statusTrace":"request = <FixtureRequest for <Function test_delete_task_access_control[member]>>\nmain_space = '6866309d85fb8d104544a61e', main_board = '6866731185fb8d104544e826'\nclient_fixture = 'member_client', expected_status = 403\nowner_client = <tests.core.client.APIClient object at 0x7f9752c6cdd0>\n\n    @pytest.mark.parametrize(\n        'client_fixture, expected_status',\n        [\n            ('owner_client', 200),\n            ('manager_client', 200),\n            ('member_client', 403),\n            ('guest_client', 403),\n        ],\n        ids=['owner', 'manager', 'member', 'guest'],\n    )\n    @allure.parent_suite(\"access_task\")\n    @allure.title(\"Проверка удаления задачи: разрешено владельцу и менеджеру, запрещено мемберу и гостю\")\n    def test_delete_task_access_control(request, main_space, main_board, client_fixture, expected_status, owner_client):\n        \"\"\"\n        Быстрая проверка прав на удаление задачи:\n          - owner, manager -> 200\n          - member, guest  -> 403\n        \"\"\"\n        # Создаём задачу владельцем\n        payload = create_task_endpoint(space_id=main_space, board=main_board)\n        create_resp = create_task(owner_client, payload)\n        assert create_resp.status_code == 200, f\"Не удалось создать задачу предварительно: {create_resp.text}\"\n        task_id = create_resp.json()[\"payload\"][\"task\"][\"_id\"]\n    \n        try:\n            client = get_client(request, client_fixture)\n            with allure.step(f\"Пытаемся удалить задачу под ролью: {client_fixture}, {expected_status}\"):\n                del_resp = client.post(**delete_task_endpoint(space_id=main_space, task_id=task_id))\n>               assert del_resp.status_code == expected_status, (\n                    f\"Ожидали {expected_status}, получили {del_resp.status_code}: {del_resp.text}\"\n                )\nE               AssertionError: Ожидали 403, получили 200: {\"payload\":{\"task\":{\"_id\":\"692472b9ef0dc1803d0d5176\",\"name\":\"Untitled task\",\"group\":\"6866731185fb8d104544e827\",\"board\":\"6866731185fb8d104544e826\",\"project\":\"686672af85fb8d104544e798\",\"parentTask\":null,\"types\":[],\"priority\":1,\"hrid\":\"CCSS-29177\",\"followers\":{\"6866346d85fb8d104544ae41\":\"creator\"},\"archiver\":null,\"completed\":false,\"assignees\":[],\"subtasks\":[],\"milestones\":[],\"dueStart\":null,\"dueEnd\":null,\"rightConnectors\":[],\"leftConnectors\":[],\"archivedAt\":null,\"completedAt\":null,\"customFields\":[],\"deleter\":\"6866310b85fb8d104544ab1d\",\"deletedAt\":\"2025-11-24T14:59:05.889Z\",\"creator\":\"6866346d85fb8d104544ae41\",\"createdAt\":\"2025-11-24T14:59:05.378Z\",\"updatedAt\":\"2025-11-24T14:59:05.911Z\",\"document\":\"692472b9ef0dc1803d0d5177\",\"milestone\":null}},\"type\":\"DeleteTask\"}\nE               assert 200 == 403\nE                +  where 200 = <Response [200]>.status_code\n\ntests/test_backend/task_service/del_task/test_delete_task.py:37: AssertionError\n\nDuring handling of the above exception, another exception occurred:\n\nrequest = <FixtureRequest for <Function test_delete_task_access_control[member]>>\nmain_space = '6866309d85fb8d104544a61e', main_board = '6866731185fb8d104544e826'\nclient_fixture = 'member_client', expected_status = 403\nowner_client = <tests.core.client.APIClient object at 0x7f9752c6cdd0>\n\n    @pytest.mark.parametrize(\n        'client_fixture, expected_status',\n        [\n            ('owner_client', 200),\n            ('manager_client', 200),\n            ('member_client', 403),\n            ('guest_client', 403),\n        ],\n        ids=['owner', 'manager', 'member', 'guest'],\n    )\n    @allure.parent_suite(\"access_task\")\n    @allure.title(\"Проверка удаления задачи: разрешено владельцу и менеджеру, запрещено мемберу и гостю\")\n    def test_delete_task_access_control(request, main_space, main_board, client_fixture, expected_status, owner_client):\n        \"\"\"\n        Быстрая проверка прав на удаление задачи:\n          - owner, manager -> 200\n          - member, guest  -> 403\n        \"\"\"\n        # Создаём задачу владельцем\n        payload = create_task_endpoint(space_id=main_space, board=main_board)\n        create_resp = create_task(owner_client, payload)\n        assert create_resp.status_code == 200, f\"Не удалось создать задачу предварительно: {create_resp.text}\"\n        task_id = create_resp.json()[\"payload\"][\"task\"][\"_id\"]\n    \n        try:\n            client = get_client(request, client_fixture)\n            with allure.step(f\"Пытаемся удалить задачу под ролью: {client_fixture}, {expected_status}\"):\n                del_resp = client.post(**delete_task_endpoint(space_id=main_space, task_id=task_id))\n                assert del_resp.status_code == expected_status, (\n                    f\"Ожидали {expected_status}, получили {del_resp.status_code}: {del_resp.text}\"\n                )\n        finally:\n            # Если не удалили в тесте — удаляем владельцем\n            check_resp = owner_client.post(**delete_task_endpoint(space_id=main_space, task_id=task_id))\n            if expected_status != 200:\n                with allure.step(\"Удаляем владельцем\"):\n                    # Для негативных ролей задача должна существовать и удалиться владельцем\n>                   assert check_resp.status_code == 200, f\"Финальное удаление владельцем не удалось: {check_resp.text}\"\nE                   AssertionError: Финальное удаление владельцем не удалось: {\"payload\":null,\"type\":\"DeleteTask\",\"error\":{\"code\":\"NotFound\",\"originalType\":\"DeleteTask\",\"meta\":{\"model\":\"Task\"}}}\nE                   assert 400 == 200\nE                    +  where 400 = <Response [400]>.status_code\n\ntests/test_backend/task_service/del_task/test_delete_task.py:46: AssertionError","steps":[{"name":"Пытаемся удалить задачу под ролью: member_client, 403","time":{"start":1763996345498,"stop":1763996346001,"duration":503},"status":"failed","statusMessage":"AssertionError: Ожидали 403, получили 200: {\"payload\":{\"task\":{\"_id\":\"692472b9ef0dc1803d0d5176\",\"name\":\"Untitled task\",\"group\":\"6866731185fb8d104544e827\",\"board\":\"6866731185fb8d104544e826\",\"project\":\"686672af85fb8d104544e798\",\"parentTask\":null,\"types\":[],\"priority\":1,\"hrid\":\"CCSS-29177\",\"followers\":{\"6866346d85fb8d104544ae41\":\"creator\"},\"archiver\":null,\"completed\":false,\"assignees\":[],\"subtasks\":[],\"milestones\":[],\"dueStart\":null,\"dueEnd\":null,\"rightConnectors\":[],\"leftConnectors\":[],\"archivedAt\":null,\"completedAt\":null,\"customFields\":[],\"deleter\":\"6866310b85fb8d104544ab1d\",\"deletedAt\":\"2025-11-24T14:59:05.889Z\",\"creator\":\"6866346d85fb8d104544ae41\",\"createdAt\":\"2025-11-24T14:59:05.378Z\",\"updatedAt\":\"2025-11-24T14:59:05.911Z\",\"document\":\"692472b9ef0dc1803d0d5177\",\"milestone\":null}},\"type\":\"DeleteTask\"}\nassert 200 == 403\n +  where 200 = <Response [200]>.status_code\n","statusTrace":"  File \"/home/runner/work/autotests/autotests/tests/test_backend/task_service/del_task/test_delete_task.py\", line 37, in test_delete_task_access_control\n    assert del_resp.status_code == expected_status, (\n","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":true,"attachmentsCount":0,"hasContent":true,"attachmentStep":false},{"name":"Удаляем владельцем","time":{"start":1763996346247,"stop":1763996346247,"duration":0},"status":"failed","statusMessage":"AssertionError: Финальное удаление владельцем не удалось: {\"payload\":null,\"type\":\"DeleteTask\",\"error\":{\"code\":\"NotFound\",\"originalType\":\"DeleteTask\",\"meta\":{\"model\":\"Task\"}}}\nassert 400 == 200\n +  where 400 = <Response [400]>.status_code\n","statusTrace":"  File \"/home/runner/work/autotests/autotests/tests/test_backend/task_service/del_task/test_delete_task.py\", line 46, in test_delete_task_access_control\n    assert check_resp.status_code == 200, f\"Финальное удаление владельцем не удалось: {check_resp.text}\"\n","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"shouldDisplayMessage":true,"attachmentsCount":0,"hasContent":true,"attachmentStep":false}],"attachments":[],"parameters":[],"stepsCount":2,"shouldDisplayMessage":true,"attachmentsCount":0,"hasContent":true,"attachmentStep":false},"afterStages":[],"labels":[{"name":"parentSuite","value":"access_task"},{"name":"tag","value":"backend"},{"name":"suite","value":"test_delete_task"},{"name":"host","value":"runnervmg1sw1"},{"name":"thread","value":"2653-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.test_backend.task_service.del_task.test_delete_task"},{"name":"resultFormat","value":"allure2"}],"parameters":[{"name":"client_fixture","value":"'member_client'"},{"name":"expected_status","value":"403"}],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Product defects","matchedStatuses":[],"flaky":false}],"history":{"statistic":{"failed":1,"broken":0,"skipped":0,"passed":11,"unknown":0,"total":12},"items":[{"uid":"730fe1d439eeb41","reportUrl":"https://vaizcom.github.io/autotests/470/#testresult/730fe1d439eeb41","status":"passed","time":{"start":1763995163969,"stop":1763995165067,"duration":1098}},{"uid":"6809f533c1bb62b4","reportUrl":"https://vaizcom.github.io/autotests/469/#testresult/6809f533c1bb62b4","status":"passed","time":{"start":1763993396946,"stop":1763993398112,"duration":1166}},{"uid":"6eb33643422c0957","reportUrl":"https://vaizcom.github.io/autotests/468/#testresult/6eb33643422c0957","status":"passed","time":{"start":1763734816203,"stop":1763734817325,"duration":1122}},{"uid":"74256fecc258cb46","reportUrl":"https://vaizcom.github.io/autotests/467/#testresult/74256fecc258cb46","status":"passed","time":{"start":1763732964545,"stop":1763732965397,"duration":852}},{"uid":"67645ab4231869ad","reportUrl":"https://vaizcom.github.io/autotests/466/#testresult/67645ab4231869ad","status":"passed","time":{"start":1763726657004,"stop":1763726657801,"duration":797}},{"uid":"f5cbccc69f3039b6","reportUrl":"https://vaizcom.github.io/autotests/465/#testresult/f5cbccc69f3039b6","status":"passed","time":{"start":1763720168738,"stop":1763720169613,"duration":875}},{"uid":"6fe4049c5ff102c3","reportUrl":"https://vaizcom.github.io/autotests/464/#testresult/6fe4049c5ff102c3","status":"passed","time":{"start":1763715468002,"stop":1763715468866,"duration":864}},{"uid":"12677fadc6b3a32f","reportUrl":"https://vaizcom.github.io/autotests/463/#testresult/12677fadc6b3a32f","status":"passed","time":{"start":1763714888118,"stop":1763714889340,"duration":1222}},{"uid":"53538f511af7ae26","reportUrl":"https://vaizcom.github.io/autotests/462/#testresult/53538f511af7ae26","status":"passed","time":{"start":1763711332241,"stop":1763711334052,"duration":1811}},{"uid":"3761a1bf220bc549","reportUrl":"https://vaizcom.github.io/autotests/461/#testresult/3761a1bf220bc549","status":"passed","time":{"start":1763710348337,"stop":1763710349806,"duration":1469}},{"uid":"555121fbcac8a0b3","reportUrl":"https://vaizcom.github.io/autotests/460/#testresult/555121fbcac8a0b3","status":"passed","time":{"start":1763651878010,"stop":1763651879227,"duration":1217}}]},"tags":["backend"]},"source":"45e22a2aa56d082b.json","parameterValues":["'member_client'","403"]}